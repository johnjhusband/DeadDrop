<!DOCTYPE html>
<!--
  DeadDrop v3.4 - Frontend
  Server-Side OAuth + Drive API Folder Upload
  Supports folder upload (all subfolders), unlimited duration via OAuth2 library

  v3.4 Update (2025-12-01):
  - Moved folder hierarchy creation from server-side to client-side
  - Added createFolderHierarchyClientSide() function using Drive API
  - Folders created directly from browser (no Apps Script time limits)
  - Fixes timeout errors with large folder structures (7000+ folders)

  v3.3 Major Update:
  - Switched from client-side OAuth to server-side OAuth using apps-script-oauth2 library
  - Removed Google Identity Services (GIS) client-side OAuth code
  - OAuth handled server-side - tokens managed by backend
  - Fixes Error 400: redirect_uri_mismatch caused by googleusercontent.com forbidden domain
  - OAuth2 library handles token refresh automatically
-->
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Files - Wildfire Video</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      width: 100%;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      padding: 40px 30px;
      text-align: center;
    }

    .logo {
      font-size: 32px;
      font-weight: 800;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .tagline {
      color: rgba(255, 255, 255, 0.95);
      font-size: 14px;
      margin-top: 8px;
    }

    .content {
      padding: 40px 30px;
    }

    .auth-section {
      text-align: center;
    }

    .sign-in-btn {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .sign-in-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(255, 107, 53, 0.3);
    }

    .upload-section {
      display: none;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #ff6b35;
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    input[type="file"] {
      display: none;
    }

    .file-input-btn {
      display: block;
      width: 100%;
      padding: 60px 20px;
      background: #f8f9fa;
      border: 3px dashed #d0d0d0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }

    .file-input-btn:hover {
      background: #e9ecef;
      border-color: #ff6b35;
    }

    .file-input-btn.dragover {
      background: #fff3e0;
      border-color: #ff6b35;
    }

    .file-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .file-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .file-item {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }

    .file-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .file-name {
      font-weight: 600;
      color: #333;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .file-size {
      color: #666;
      font-size: 12px;
      margin-left: 10px;
    }

    .file-status {
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      margin-left: 10px;
    }

    .status-pending { background: #e3f2fd; color: #1976d2; }
    .status-uploading { background: #fff3e0; color: #f57c00; }
    .status-verifying { background: #e1f5fe; color: #0288d1; }
    .status-complete { background: #e8f5e9; color: #388e3c; }
    .status-failed { background: #ffebee; color: #d32f2f; }

    .progress-bar-container {
      width: 100%;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%);
      transition: width 0.3s;
      width: 0%;
    }

    .file-error {
      color: #d32f2f;
      font-size: 12px;
      margin-top: 5px;
    }

    .batch-summary {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .upload-btn, .cancel-btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 10px;
    }

    .upload-btn {
      background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
      color: white;
    }

    .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 107, 53, 0.3); }
    .upload-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

    .cancel-btn {
      background: #f44336;
      color: white;
    }

    .debug-log {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 5px;
      color: #333;
    }

    .log-error { color: #d32f2f; font-weight: 600; }
    .log-success { color: #388e3c; font-weight: 600; }

    .help-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .completion-summary {
      text-align: center;
      padding: 30px;
      display: none;
    }

    .completion-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .completion-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 10px;
    }

    .completion-stats {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">Wildfire Video</div>
      <div class="tagline">Professional Video Upload Portal</div>
    </div>

    <div class="content">
      <!-- Authentication Section -->
      <div id="authSection" class="auth-section">
        <p style="margin-bottom: 20px; color: #666;">Sign in with your Google account to upload files</p>
        <button id="signInBtn" class="sign-in-btn">Sign in with Google</button>
      </div>

      <!-- Upload Section -->
      <div id="uploadSection" class="upload-section">
        <!-- Project Name Input -->
        <div class="form-group">
          <label for="projectName">Project Name (Optional)</label>
          <input type="text" id="projectName" placeholder="e.g., LawFirm_Commercial or leave blank to use folder name">
          <div class="help-text">If left blank, the selected folder name will be used</div>
        </div>

        <!-- Folder Selection -->
        <div class="form-group">
          <label>Select Folder</label>
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" webkitdirectory multiple>
            <label for="fileInput" class="file-input-btn" id="fileInputLabel">
              <div class="file-icon">üìÅ</div>
              <div><strong>Choose folder</strong> or drag and drop</div>
              <div class="help-text">Select entire folder with all files and subfolders (750GB per file)</div>
            </label>
          </div>
        </div>

        <!-- Batch Summary -->
        <div id="batchSummary" class="batch-summary" style="display: none;">
          <div class="summary-row">
            <span><strong>Files Selected:</strong></span>
            <span id="fileCount">0</span>
          </div>
          <div class="summary-row">
            <span><strong>Total Size:</strong></span>
            <span id="totalSize">0 MB</span>
          </div>
          <div class="summary-row">
            <span><strong>Status:</strong></span>
            <span id="batchStatus">Ready</span>
          </div>
        </div>

        <!-- File List -->
        <div id="fileList" class="file-list"></div>

        <!-- Upload Controls -->
        <div id="uploadControls" style="margin-top: 20px; display: none;">
          <button id="uploadBtn" class="upload-btn">Start Upload</button>
          <button id="cancelBtn" class="cancel-btn" style="display: none;">Cancel Upload</button>
        </div>

        <!-- Completion Summary -->
        <div id="completionSummary" class="completion-summary">
          <div class="completion-icon">‚úÖ</div>
          <div class="completion-title">Upload Complete!</div>
          <div class="completion-stats" id="completionStats"></div>
          <button onclick="location.reload()" class="upload-btn">Upload More Files</button>
        </div>

        <!-- Debug Log -->
        <div id="debugLog" class="debug-log"></div>
      </div>
    </div>
  </div>

  <script>
    // ========== GLOBAL VARIABLES ==========
    
    const SCOPE = 'https://www.googleapis.com/auth/drive.file';
    const CHUNK_SIZE = 256 * 1024 * 1024; // 256MB chunks
    const MAX_FILE_SIZE = 750 * 1024 * 1024 * 1024; // 750GB

    let selectedFiles = [];
    let uploadCancelled = false;
    let accessToken = null;

    // ========== PAGE LOAD ==========

    window.addEventListener('DOMContentLoaded', () => {
      log('Page loaded');
      
      // Check if user is already authorized
      checkAuthorization();

      // Setup event listeners
      document.getElementById('signInBtn').addEventListener('click', handleSignIn);
      document.getElementById('fileInput').addEventListener('change', handleFileSelect);
      document.getElementById('uploadBtn').addEventListener('click', startUpload);
      document.getElementById('cancelBtn').addEventListener('click', () => {
        uploadCancelled = true;
        log('Upload cancelled by user');
      });
    });

    // ========== OAUTH AUTHENTICATION ==========

    function checkAuthorization() {
      log('Checking authorization status...');
      
      google.script.run
        .withSuccessHandler(authorized => {
          if (authorized) {
            log('User is authorized');
            showUploadSection();
          } else {
            log('User not authorized - showing sign in');
            showAuthSection();
          }
        })
        .withFailureHandler(err => {
          log('ERROR checking authorization: ' + err.message, true);
          showAuthSection();
        })
        .isAuthorized();
    }

    function handleSignIn() {
      log('Getting authorization URL...');
      
      google.script.run
        .withSuccessHandler(authUrl => {
          log('Opening authorization popup...');
          
          // Open auth URL in popup
          const width = 600;
          const height = 700;
          const left = (screen.width - width) / 2;
          const top = (screen.height - height) / 2;
          
          const popup = window.open(
            authUrl,
            'oauth',
            'width=' + width + ',height=' + height + ',left=' + left + ',top=' + top
          );

          // Poll for popup close
          const pollTimer = setInterval(() => {
            if (popup.closed) {
              clearInterval(pollTimer);
              log('Popup closed - checking authorization...');
              
              // Wait a moment for OAuth callback to complete
              setTimeout(() => {
                checkAuthorization();
              }, 1000);
            }
          }, 500);
        })
        .withFailureHandler(err => {
          log('ERROR getting auth URL: ' + err.message, true);
          showError('Failed to initialize authorization: ' + err.message);
        })
        .getAuthUrl();
    }

    function showAuthSection() {
      document.getElementById('authSection').style.display = 'block';
      document.getElementById('uploadSection').style.display = 'none';
    }

    function showUploadSection() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('uploadSection').style.display = 'block';
    }

    // ========== FILE SELECTION ==========

    function handleFileSelect(e) {
      const files = Array.from(e.target.files);
      
      if (files.length === 0) {
        log('No files selected');
        return;
      }

      log('Files selected: ' + files.length);
      
      // Validate files
      selectedFiles = files.filter(file => {
        if (file.size > MAX_FILE_SIZE) {
          log('Skipping file (too large): ' + file.name + ' (' + formatFileSize(file.size) + ')', true);
          return false;
        }
        return true;
      });

      if (selectedFiles.length === 0) {
        showError('No valid files selected');
        return;
      }

      displayFiles();
      document.getElementById('uploadControls').style.display = 'block';
    }

    function displayFiles() {
      const fileList = document.getElementById('fileList');
      const batchSummary = document.getElementById('batchSummary');
      
      fileList.innerHTML = '';
      
      let totalSize = 0;
      
      selectedFiles.forEach((file, index) => {
        totalSize += file.size;
        
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.id = 'file-' + index;
        
        const relativePath = file.webkitRelativePath || file.name;
        
        fileItem.innerHTML = `
          <div class="file-item-header">
            <div class="file-name" title="${relativePath}">${relativePath}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
            <div class="file-status status-pending" id="status-${index}">Pending</div>
          </div>
          <div class="progress-bar-container">
            <div class="progress-bar" id="progress-${index}"></div>
          </div>
          <div class="file-error" id="error-${index}" style="display: none;"></div>
        `;
        
        fileList.appendChild(fileItem);
      });

      document.getElementById('fileCount').textContent = selectedFiles.length;
      document.getElementById('totalSize').textContent = formatFileSize(totalSize);
      batchSummary.style.display = 'block';
    }

    // ========== UPLOAD ==========

    async function startUpload() {
      log('Starting upload...');
      
      document.getElementById('uploadBtn').disabled = true;
      document.getElementById('cancelBtn').style.display = 'inline-block';
      uploadCancelled = false;

      try {
        // Get access token
        log('Getting access token...');
        accessToken = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .getAccessToken();
        });
        
        log('Access token obtained');

        // Get project name
        let projectName = document.getElementById('projectName').value.trim();
        if (!projectName && selectedFiles[0].webkitRelativePath) {
          projectName = selectedFiles[0].webkitRelativePath.split('/')[0];
        }
        if (!projectName) {
          projectName = 'Upload';
        }

        // Calculate total size
        const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);

        // Prepare upload (create folder)
        log('Preparing upload folder...');
        const prepareResult = await new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(resolve)
            .withFailureHandler(reject)
            .prepareUpload(projectName, selectedFiles.length, totalSize);
        });

        if (!prepareResult.success) {
          throw new Error(prepareResult.message);
        }

        log('Upload folder created: ' + prepareResult.folderName);
        const rootFolderId = prepareResult.folderId;

        // Extract folder structure
        const folderPaths = extractFolderPaths(selectedFiles);
        log('Folder paths: ' + folderPaths.length);

        // Create folder hierarchy client-side
        let folderIdMap = { '': rootFolderId };

        if (folderPaths.length > 0) {
          log('Creating folder hierarchy...');
          folderIdMap = await createFolderHierarchyClientSide(rootFolderId, folderPaths);
          log('Folder hierarchy created');
        }

        // Upload files
        for (let i = 0; i < selectedFiles.length; i++) {
          if (uploadCancelled) {
            log('Upload cancelled');
            break;
          }

          const file = selectedFiles[i];
          await uploadFile(file, i, folderIdMap);
        }

        if (!uploadCancelled) {
          showCompletion();
        }

      } catch (error) {
        log('ERROR in upload: ' + error.message, true);
        showError('Upload failed: ' + error.message);
      } finally {
        document.getElementById('uploadBtn').disabled = false;
        document.getElementById('cancelBtn').style.display = 'none';
      }
    }

    async function uploadFile(file, index, folderIdMap) {
      log('Uploading: ' + file.name);
      
      updateFileStatus(index, 'uploading', 'Uploading...');

      try {
        // Get folder path from webkitRelativePath
        let folderPath = '';
        if (file.webkitRelativePath) {
          const parts = file.webkitRelativePath.split('/');
          parts.pop(); // Remove filename
          folderPath = parts.join('/');
        }

        const targetFolderId = folderIdMap[folderPath] || folderIdMap[''];

        // Create resumable upload session
        const metadata = {
          name: file.name,
          mimeType: file.type || 'application/octet-stream',
          parents: [targetFolderId]
        };

        const initResponse = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(metadata)
        });

        if (!initResponse.ok) {
          throw new Error('Failed to initialize upload: ' + initResponse.statusText);
        }

        const sessionUrl = initResponse.headers.get('Location');
        
        // Upload file in chunks
        const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
        let uploadedBytes = 0;

        for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
          if (uploadCancelled) return;

          const start = chunkIndex * CHUNK_SIZE;
          const end = Math.min(start + CHUNK_SIZE, file.size);
          const chunk = file.slice(start, end);

          const chunkResponse = await fetch(sessionUrl, {
            method: 'PUT',
            headers: {
              'Content-Range': 'bytes ' + start + '-' + (end - 1) + '/' + file.size
            },
            body: chunk
          });

          if (!chunkResponse.ok && chunkResponse.status !== 308) {
            throw new Error('Chunk upload failed: ' + chunkResponse.statusText);
          }

          uploadedBytes = end;
          const progress = Math.round((uploadedBytes / file.size) * 100);
          updateFileProgress(index, progress);
        }

        updateFileStatus(index, 'complete', 'Complete');
        log('‚úì Uploaded: ' + file.name);

      } catch (error) {
        log('ERROR uploading ' + file.name + ': ' + error.message, true);
        updateFileStatus(index, 'failed', 'Failed');
        updateFileError(index, error.message);
      }
    }

    function extractFolderPaths(files) {
      const paths = new Set();
      
      files.forEach(file => {
        if (file.webkitRelativePath) {
          const parts = file.webkitRelativePath.split('/');
          parts.pop(); // Remove filename
          
          let currentPath = '';
          parts.forEach(part => {
            currentPath += (currentPath ? '/' : '') + part;
            paths.add(currentPath);
          });
        }
      });

      return Array.from(paths);
    }

    async function createFolderHierarchyClientSide(rootFolderId, folderPaths) {
      const folderIdMap = { '': rootFolderId };

      // Sort by depth (shallowest first)
      const sortedPaths = folderPaths.sort((a, b) =>
        a.split('/').length - b.split('/').length
      );

      for (const path of sortedPaths) {
        const parts = path.split('/');
        const parentPath = parts.slice(0, -1).join('/');
        const folderName = parts[parts.length - 1];
        const parentFolderId = folderIdMap[parentPath];

        // Create folder using Drive API
        const metadata = {
          name: folderName,
          mimeType: 'application/vnd.google-apps.folder',
          parents: [parentFolderId]
        };

        const response = await fetch(
          'https://www.googleapis.com/drive/v3/files',
          {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + accessToken,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(metadata)
          }
        );

        if (!response.ok) {
          throw new Error('Failed to create folder: ' + folderName);
        }

        const result = await response.json();
        folderIdMap[path] = result.id;
      }

      return folderIdMap;
    }

    // ========== UI UPDATES ==========

    function updateFileStatus(index, status, text) {
      const statusEl = document.getElementById('status-' + index);
      if (statusEl) {
        statusEl.className = 'file-status status-' + status;
        statusEl.textContent = text;
      }
    }

    function updateFileProgress(index, percent) {
      const progressEl = document.getElementById('progress-' + index);
      if (progressEl) {
        progressEl.style.width = percent + '%';
      }
    }

    function updateFileError(index, message) {
      const errorEl = document.getElementById('error-' + index);
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      }
    }

    function showCompletion() {
      document.getElementById('completionSummary').style.display = 'block';
      document.getElementById('fileList').style.display = 'none';
      document.getElementById('uploadControls').style.display = 'none';

      const completed = selectedFiles.length;
      const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
      
      document.getElementById('completionStats').textContent = 
        completed + ' files (' + formatFileSize(totalSize) + ') uploaded successfully';
    }

    function showError(message) {
      alert('Error: ' + message);
    }

    // ========== UTILITIES ==========

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function log(message, isError = false) {
      const timestamp = new Date().toLocaleTimeString();
      const entry = '[' + timestamp + '] ' + message;
      
      console.log(entry);
      
      const debugLog = document.getElementById('debugLog');
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry' + (isError ? ' log-error' : '');
      logEntry.textContent = entry;
      debugLog.appendChild(logEntry);
      debugLog.scrollTop = debugLog.scrollHeight;
    }
  </script>
</body>
</html>
